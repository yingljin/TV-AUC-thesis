---
title: "TV-auc simulation"
author: "Ying Jin"
date: "8/18/2021"
output: 
  html_document:
     number_sections: yes
     toc: yes
     toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)

set.seed(818)
library(here)
library(tidyverse)
library(ggplot2)
```

# Time-Varying AUC
```{r}
load(here("outputData/auc.RData"))
load(here("outputData/concordance.RData"))
```


## Simulation results

```{r}
auc_df_mean %>%
  ggplot(aes(x = time_bin, y = auc, col = estimator))+
  geom_line()+
  labs(title = "Binned average time-varying AUC")
```

```{r}
auc_df %>% 
  left_join(true_auc %>% dplyr::select(time_bin, auc) %>% rename(true = auc)) %>%
  relocate(time_bin, .before = 1) %>%
  pivot_longer(3:6, names_to = "estimator", values_to = "auc") %>%
  ggplot(aes(x = time, y = auc, group = estimator, col = estimator))+
  geom_smooth(se = F)+
  labs(title = "Smoothed time-varying AUC")
```

```{r}
auc_df%>%
  pivot_longer(2:4, names_to = "estimator", values_to = "auc") %>%
  ggplot(aes(x = factor(time_bin), y = auc))+
  geom_boxplot()+
  facet_wrap(~estimator, nrow = 3, ncol = 1)+
  labs(x = "",)+
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank())
```

## Problem with true auc

Abnormal value of specificity (1.013>>1) when when t = 0.145 and eta = 1.76767677

```{r}
plot(auc~time_bin, auc_df_mean %>% filter(estimator=="true"))
```

## Concordance

```{r}
c_df %>%  ggplot(aes(x = estimator, y = concordance))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 60))+
  geom_hline(yintercept = true_c)+
  labs(title = "Concordance")
```

# Questions

1. Restricting both eta and t when calculating true sensitivity and specificity?
1. Technically, time cannot be greater than 1

$$t_c = min\{1, rexp(1/5)\} \leq 1$$

$$t = min\{t_e, t_c\}\leq t_c \leq 1$$
but if I restrict time to 1 when calculating specificity, the true AUC ended up very low.

Is it because when we are trying to calculate true AUC, we assume a distribution of t that takes value $(0, \infty)$, and did not consider the distribution of censoring time?

In other words, in derivation of sensivibity and specificity formula, we did not include parameters about censering distribution. How is censoring accounted for than in the estimation? Is it by the defination formula?

3. Estimating survival function and density for concordance
- marginal: integrating out linear predictor($\eta$)
- mathematical derivation

# Notes

<!-- code  -->

## TV-AUC
Figure

## Concordance
Figure

# Non-parametric estimators

## TV-AUC
- Unsmoothed non-parametric
- Smoothed parametric

## Concordance

- Integrated I/D AUC:
Fully non-parametric I/D AUC (unsmoothed)
Fully non-parametric I/D AUC (smoothed)
Heagerty & Zheng

- Gonen & Heller3

- Harellâ€™s 

# Extensions

## Cumulative/Dynamic estimator

## Complex survey Design
- Clustered sampling scheme



