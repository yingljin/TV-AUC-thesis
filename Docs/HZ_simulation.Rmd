---
title: "TV-auc simulation"
author: "Ying Jin"
date: "8/18/2021"
output: 
  html_document:
     number_sections: yes
     toc: yes
     toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)

set.seed(818)
library(here)
library(tidyverse)
library(ggplot2)
```

# Time-Varying AUC
```{r}
load(here("outputData/auc.RData"))
load(here("outputData/concordance.RData"))
```


## Simulation results

```{r}
auc_df %>% dplyr::select(-time_bin) %>%
  pivot_longer(2:5, names_to = "estimator", values_to = "auc") %>%
  ggplot(aes(x = time, y = auc, col = estimator))+
  geom_line(alpha = 0.5)+
  labs(title = "True time-varying AUC")
```

```{r}
auc_df %>% dplyr::select(-time_bin) %>%
  pivot_longer(2:5, names_to = "estimator", values_to = "auc") %>%
  ggplot(aes(x = time, y = auc, group = estimator, col = estimator))+
  geom_smooth(se = F)+
  labs(title = "Smoothed time-varying AUC")
```

```{r}
auc_df%>%
  pivot_longer(2:4, names_to = "estimator", values_to = "auc") %>%
  ggplot(aes(x = factor(time_bin), y = auc))+
  geom_boxplot()+
  facet_wrap(~estimator, nrow = 3, ncol = 1)+
  labs(x = "",)+
  theme(axis.ticks.x = element_blank(), axis.text.x = element_blank())
```

## Concordance

```{r}
c_df %>%  ggplot(aes(x = estimator, y = concordance))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 60, vjust = 0.5))+
  geom_hline(yintercept = true_c, col = "red")+
  labs(title = "Concordance")
```

# Questions

1. Restricting both eta and t when calculating true sensitivity and specificity?
- doing that kinda speed the simulation up
2. Technically, time cannot be greater than 1

$$t_c = min\{1, rexp(1/5)\} \leq 1$$

$$t = min\{t_e, t_c\}\leq t_c \leq 1$$
but if I restrict time to 1 when calculating specificity, the true AUC ended up very low.Is it because when we are trying to calculate true AUC, we assume a distribution of t that takes value $(0, \infty)$, and did not consider the distribution of censoring time? 

- Yes. Also if censor time is independent of event time, the math formula would stay the same.

3. Estimating survival function and density for concordance
- marginal: integrating out linear predictor($\eta$)
- use the trucated version of concordance in HZ paper, where weight is devided by its intergral
(also 1-max(S_t)^2)

4. For true AUC:

- Calculate in the same way but on a denser interval
- Use linear interpolation to evaluated it at all the generated event time (funciton approx)
- So we don't have to bin/smooth estimated AUC anymore

5. Try to expand iteration and sample size. Identify where it takes most time


# Notes

<!-- code  -->

## TV-AUC
Figure

## Concordance
Figure

# Non-parametric estimators

## TV-AUC
- Unsmoothed non-parametric
- Smoothed parametric

## Concordance

- Integrated I/D AUC:
Fully non-parametric I/D AUC (unsmoothed)
Fully non-parametric I/D AUC (smoothed)
Heagerty & Zheng

- Gonen & Heller3

- Harellâ€™s 

# Extensions

## Cumulative/Dynamic estimator

## Complex survey Design
- Clustered sampling scheme



