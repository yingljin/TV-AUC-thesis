---
title: "TV-auc simulation"
author: "Ying Jin"
output: 
  html_document:
     number_sections: yes
     toc: yes
     toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)

set.seed(818)
library(here)
library(tidyverse)
library(ggplot2)
```

# Time-Varying AUC
```{r}
load(here("outputData/true_values.RData"))
load(here("outputData/estimated_values.RData"))
load(here("outputData/weighted_gam_by_iter.RData"))
```

```{r}
auc_df <- auc_df %>% left_join(wt_gam_df, by = "time")
```

## Simulation results

```{r}
# use interpolation to estimate true_auc
interpolated_auc<-approx(x = true_auc_sort$time_bin, y = true_auc_sort$auc, xout = auc_df$time)$y
# plot(auc_df$time, interpolated_auc)
auc_df$true <- interpolated_auc
```

```{r}
auc_df %>% 
  pivot_longer(2:6, names_to = "estimator", values_to = "auc") %>%
  ggplot(aes(x = time, y = auc, col = estimator))+
  geom_line(alpha = 0.5)+
  labs(title = "True time-varying AUC")
```

```{r}
auc_df %>% 
  pivot_longer(2:6, names_to = "estimator", values_to = "auc") %>%
  ggplot(aes(x = time, y = auc, group = estimator, col = estimator))+
  geom_smooth(se = F)+
  labs(title = "Smoothed time-varying AUC")
```

```{r}
brk <- seq(0, 1, 0.01)
auc_df %>%
  mutate(time_bin = cut(auc_df$time, breaks = brk, include.lowest = T,
                       seq(0.005, 0.995, 0.01))) %>%
  dplyr::select(-true) %>%
  pivot_longer(2:5, names_to = "estimator", values_to = "auc") %>%
  ggplot(aes(x = factor(time_bin), y = auc))+
  geom_boxplot(outlier.size = 0.5)+
  facet_wrap(~estimator, nrow = 4, ncol = 1)+
  labs(x = "",)+
  scale_x_discrete(breaks = c("0.005", "0.495", "0.995"))
```

## Concordance

```{r}
c_df %>%  ggplot(aes(x = estimator, y = concordance))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 60, vjust = 0.5))+
  geom_hline(yintercept = true_c, col = "red")+
  labs(title = "Concordance")
```

# Bias of smoothed empirical estimator


# Notes

1. For smoothed empirical estimator, maybe try inverse variance weighted gam?
   - calculated individual variance for each observation (time point in this case)
   - but could it be the outcome (empirical extimator) is highly skewed?
   
2. Investigate the weird outliers of smoothed empirical estimator

3. Add Gonen & Heller estimator for concordance
   - https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4886856/

4. Add model with noise signals

   
   
## TV-AUC
- Unsmoothed non-parametric
- Smoothed parametric

## Concordance

- Integrated I/D AUC:
Fully non-parametric I/D AUC (unsmoothed)
Fully non-parametric I/D AUC (smoothed)
Heagerty & Zheng

- Gonen & Heller3

- Harellâ€™s C-index: fully empirical

# Extensions

## Cumulative/Dynamic estimator

## Complex survey Design
- Clustered sampling scheme



