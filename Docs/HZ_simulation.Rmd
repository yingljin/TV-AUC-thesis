---
title: "TV-auc simulation"
author: "Ying Jin"
output: 
  html_document:
     number_sections: yes
     toc: yes
     toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)

set.seed(818)
library(here)
library(tidyverse)
library(ggplot2)
```


# Introduction

Time-dependent AUC and concordance are important model evaluation criteria for survival models. While one popular estimator for incident/dynamic AUC is a semi-parametric estimator proposed by Heagerty and Zheng (2005), there is a critical flaw that makes this estimator very sensitive to noise signals or outliers. 
With the presence of noise, this estimator tends to overfit to the training data, while out-of-sample estimators are inflated unresonably high (as demonstrated in the image below). 

In this report, we attempt to identify key flaw in HZ estimators of I/D AUC and their impact on Concordance, also compare prediction performance of common estimators with the presence of noise.

```{r, echo=FALSE, out.width='80%'}
knitr::include_graphics("../screenshots/outlierauc.png")
```

# Method

We are going to estimated time-dependent AUC and concrdance using several different methods on simulated data set and compare their performance.

## Incident/Dynamic AUC

For a fixed time point $t > 0$ at various candidate thresholds $c$ of the biomarker $\eta_i$, define:  
$$\begin{align*}
    \text{sensitivity}^{\mathbb{I}}(c,t) = & \text{TP}_t^{\mathbb{I}}(c) = \text{Pr}(\eta_i > c|T_i = t) \\
    1-\text{specificity}^{\mathbb{D}}(c,t) = & \text{FP}_t^{\mathbb{D}}(c) = 1-\text{Pr}(\eta_i \leq c|T_i > t) \\
\end{align*}$$

from which one can defined an incident/dynamic receiver operator characteristic (ROC) curve (p denotes a dynamic  value of FP):

$$\begin{align*}
    \text{ROC}_t^{\mathbb{I}/\mathbb{D}}(p) =  \text{TP}_t^{\mathbb{I}}\{[\text{FP}_t^{\mathbb{D}}]^{-1}(p)\}
\end{align*}$$

Consequently I/D AUC:

$$\begin{align*}
    \text{AUC}^{\mathbb{I}/\mathbb{D}}(t) &= \int_0^1 \text{ROC}_t^{\mathbb{I}/\mathbb{D}}(p)dp
\end{align*}$$

### Heagerty & Zheng estimator (semi-parametric)

From the Heagerty & Zheng paper, sensitivity and specificity is estimated based on cox PH model:

$$\begin{align*}
    \log \lambda_i(t) &= \log \lambda_0(t) + \bf{x}_i \bf{\beta} \\
    &= \log \lambda_0(t) + \eta_i \\
\end{align*}$$

The sensitivity estimator is based on cox coefficients: 

$$\hat{\text{TP}_t}^{\mathbb{I}}(c)=\frac{\sum_{k}I(\eta_k>c)I(T_k=t)exp(\eta_t)}{\sum_{j}I(T_j=t)exp(\eta_j)}$$

But the 1-specificity is non-parametric:

$$\text{FP}_t^{\mathbb{D}}(c) = \frac{\sum_{k}I(\eta_k>c)I(T_k>t)}{\sum_{j}I(T_j>t)}$$

$ROC(t)$ and $AUC(t)$ estimated using formulas in section 2.1 by plugging in above estimators of TP and FP. $AUC(t)$ is only evaluated as unique event time. 

### Fully non-parametric

$$\hat{\text{TP}_t}^{\mathbb{I}}(c) = \frac{\sum_{k}I(\eta_k>c)I(T_k=t)}{\sum_{j}I(T_j=t)}$$
$$\hat{\text{FP}_t}^{\mathbb{D}}(c) = \frac{\sum_{k}I(\eta_k>c)I(T_k>t)}{\sum_{j}I(T_j>t)}$$

$ROC(t)$, $AUC(t)$ estimated using the same formula as previous sections

Since non-parametric $AUC(t)$ is highly unstable, we can also smoothing it using **regression splines**.

## Concordance

### Integrating AUC(t)

$$\begin{align*}
\text{C} &= \int_0^\tau\text{AUC}^{\mathbb{I}/\mathbb{D}}(t)w^{\tau(t)}dt
\end{align*}$$

Where $\tau$ is the end of follow-up period, and

$$w^{\tau}(t) = 2f(t)S(t)/W^{\tau}$$

$$W^{\tau} =\int_0^\tau2f(t)S(t)dt =1-S^2(\tau)$$
$S(t)$ can be estimated from Kaplan-Meier curve. As proposed in HZ paper, $f(t)$ can be calculated using Trapezoidal rule over $S(t)$. However, we think using derivative of smoothed $S(t)$ is more robust.

### Gonen & Heller

$$C = \frac{2}{n(n-1)}\sum_{i<j}{\frac{I(\eta_j-\eta_i<0)}{1+exp(\eta_j-\eta_i)}+\frac{I(\eta_i-\eta_j<0)}{1+exp(\eta_i-\eta_j)}}$$

### Harrel's C-index

$$C = \frac{\sum_{i<j}I(T_i<T_j)I(\eta_i>\eta_j)I(\delta_i=1)+I(T_i>T_j)I(\eta_i<\eta_j)I(\delta_i=1)}{\sum_{i<j}I(T_i<T_j)I(\delta_i=1)+I(T_i>T_j)I(\delta_i=1)}$$

# Results

## Simulation set up

- 1000 iterations, sample size = 500
- Signals $X = (X_1, X_2, X_3)$, $X_i \overset{i.i.d}{\sim} N(0, 1)$; true coefficients $\beta = (1, -1, 0.25)$; biomarker $\eta = \beta X$
- Event time generated from Weibull baseline hazard
- Censor time generated from exponential distribution, with maximum censor time $\tau = 1$

## Preliminary results

```{r}
load(here("outputData/true_values.RData"))
load(here("outputData/estimated_values.RData"))
#load(here("outputData/weighted_gam_by_iter.RData"))
```

```{r}
# auc_df <- auc_df %>% left_join(wt_gam_df, by = "time")
```


```{r}
# use interpolation to estimate true_auc
interpolated_auc_train<-approx(x = true_auc_sort$time_bin, y = true_auc_sort$auc, 
                         xout = auc_df_train$time)$y
interpolated_auc_test<-approx(x = true_auc_sort$time_bin, y = true_auc_sort$auc, 
                         xout = auc_df_test$time)$y

# plot(auc_df$time, interpolated_auc)
auc_df_train$true <- interpolated_auc_train
auc_df_test$true <- interpolated_auc_test

auc_df_train$sample = "in-sample"
auc_df_test$sample = "out-of-sample"
auc_df <- rbind(auc_df_train, auc_df_test)

# some more cleaning

```

```{r eval=FALSE}
auc_df %>% 
  pivot_longer(2:6, names_to = "estimator", values_to = "auc") %>%
  ggplot(aes(x = time, y = auc, col = estimator))+
  geom_line(alpha = 0.5)+
  labs(title = "True time-varying AUC")
```


```{r eval=FALSE}
auc_df %>% 
  pivot_longer(2:6, names_to = "estimator", values_to = "auc") %>%
  ggplot(aes(x = time, y = auc, group = estimator, col = estimator))+
  geom_point(na.rm = T, size = 0.5, alpha = 0.5)+
  labs(title = "Time-varying AUC")
```

```{r}
p1 <- auc_df %>% dplyr::select(time, contains("_eta1"), true, sample) %>%
  pivot_longer(2:4, names_to = "estimator", values_to = "auc") %>%
  mutate(estimator = factor(estimator, levels = c("HZ_eta1", "empirical_eta1", "sm_empirical_eta1"),
                            labels = c("HZ", "NP", "SNP"))) %>%
  ggplot()+
  geom_smooth(aes(x = time, y = auc, group = sample, col = sample), 
              se = F, formula = y~s(x, k=30, bs = "cs"), na.rm = T, method = "gam")+
  geom_line(aes(x = time, y = true), na.rm = T)+
  facet_wrap(~estimator)+
  labs(title = "No noise")
```

```{r}
p2 <- auc_df %>% dplyr::select(time, contains("_eta2"), true, sample) %>%
  pivot_longer(2:4, names_to = "estimator", values_to = "auc") %>%
  mutate(estimator = factor(estimator, levels = c("HZ_eta2", "empirical_eta2", "sm_empirical_eta2"),
                            labels = c("HZ", "NP", "SNP"))) %>%
  ggplot()+
  geom_smooth(aes(x = time, y = auc, group = sample, col = sample), 
              se = F, formula = y~s(x, k=30, bs = "cs"), na.rm = T, method = "gam")+
  geom_line(aes(x = time, y = true), na.rm = T)+
  facet_wrap(~estimator)+
  labs(title = "20 noise signals")
```

```{r}
p3 <- auc_df %>% dplyr::select(time, contains("_eta3"), true, sample) %>%
  pivot_longer(2:4, names_to = "estimator", values_to = "auc") %>%
  mutate(estimator = factor(estimator, levels = c("HZ_eta3", "empirical_eta3", "sm_empirical_eta3"),
                            labels = c("HZ", "NP", "SNP"))) %>%
  ggplot()+
  geom_smooth(aes(x = time, y = auc, group = sample, col = sample), 
              se = F, formula = y~s(x, k=30, bs = "cs"), na.rm = T, method = "gam")+
  geom_line(aes(x = time, y = true), na.rm = T)+
  facet_wrap(~estimator)+
  labs(title = "100 noise signals")
```

```{r, fig.width=8, fig.height=8}
ggpubr::ggarrange(p1, p2, p3, nrow = 3, ncol = 1, common.legend = T)
```

```{r, eval=FALSE, fig.height=5, fig.width=10}
brk <- seq(0, 1, 0.01)
auc_df %>%
  mutate(time_bin = cut(auc_df$time, breaks = brk, include.lowest = T,
                       seq(0.005, 0.995, 0.01))) %>%
  dplyr::select(-true) %>%
  pivot_longer(2:5, names_to = "estimator", values_to = "auc") %>%
  ggplot(aes(x = factor(time_bin), y = auc))+
  geom_boxplot(outlier.size = 0.5)+
  facet_wrap(~estimator, nrow = 4, ncol = 1)+
  labs(x = "", title = "Distribution of estimated AUC")+
  scale_x_discrete(breaks = c("0.005", "0.495", "0.995"))
```


```{r, out.width='100%'}
c_df_train$estimator <- factor(c_df_train$estimator, levels = levels(c_df_train$estimator),
                         labels = c("Harrel's C", "Gonen-Heller", "HZ_S",
                                    "HZ_SmS",
                                    "NP_S",
                                    "NP_SmS",
                                    "SNP_S",
                                    "SNP_SmS"))
c_df_train$signal <- factor(c_df_train$signal, levels = levels(as.factor(c_df_train$signal)),
                           labels = c("No noise", "20 noise", "100 noise"))

c_df_train %>%  ggplot(aes(x = estimator, y = concordance))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 60, vjust = 0.5))+
  geom_hline(yintercept = true_c, col = "red")+
  facet_wrap(~signal)+
  labs(title = "In-sample concordance")
```

```{r, out.width='100%'}
c_df_test$estimator <- factor(c_df_test$estimator, levels = levels(c_df_test$estimator),
                         labels = c("Harrel's C", "Gonen-Heller", "HZ_S",
                                    "HZ_SmS",
                                    "NP_S",
                                    "NP_SmS",
                                    "SNP_S",
                                    "SNP_SmS"))

c_df_test$signal <- factor(c_df_test$signal, levels = levels(as.factor(c_df_test$signal)),
                           labels = c("No noise", "20 noise", "100 noise"))
c_df_test %>%  ggplot(aes(x = estimator, y = concordance))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 60, vjust = 0.5))+
  geom_hline(yintercept = true_c, col = "red")+
  facet_wrap(~signal)+
  labs(title = "Out of sample concordance")
```

Note: 

- HZ_S: Heagerty-Zhang estimator of $AUC(t)$ integrated using weights from survival function

- HZ_SmS: Heagerty-Zhang estimator of $AUC(t)$ integrated using weights from smoothed survival function

- NP_S: Non-parametric estimator of $AUC(t)$ integrated using weights from survival function


- NP_SmS: Non-parametric estimator of $AUC(t)$ integrated using weights from smoothed survival function

- SNP_S: Smoothed non-parametric estimator of $AUC(t)$ integrated using weights from survival function

- SNP_SmS: Smoothed non-parametric estimator of $AUC(t)$ integrated using weights from smoothed survival function

# References

Heagerty, P. J., & Zheng, Y. (2005). Survival model predictive accuracy and ROC curves. Biometrics, 61(1), 92–105. https://doi.org/10.1111/j.0006-341X.2005.030814.x
