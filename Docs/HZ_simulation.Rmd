---
title: "TV-auc simulation"
author: "Ying Jin"
output: 
  html_document:
     number_sections: yes
     toc: yes
     toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F)

set.seed(818)
library(here)
library(tidyverse)
library(ggplot2)
```


# Introduction

- AUC and measures of discrimination are important model evaluation criteria for survival models.
- Many estimators proposed, some work done examining the problem with violations of the PH assumption
- No previous work identified critical flaw which affects reasonableness of these estimatorsâ€™ use in prediction work
- We are trying to identifying key flaw in common estimators of I/D AUC and their impact on Concordance
- also propose which estimators to use in the future for prediction work

# Method

## Incidence/Dynamic AUC

For a fixed time point $t > 0$ at various candidate thresholds $c$ of the biomarker $\eta_i$, define:  
$$\begin{align*}
    \text{sensitivity}^{\mathbb{I}}(c,t) = & \text{TP}_t^{\mathbb{I}}(c) = \text{Pr}(\eta_i > c|T_i = t) \\
    1-\text{specificity}^{\mathbb{D}}(c,t) = & \text{FP}_t^{\mathbb{D}}(c) = 1-\text{Pr}(\eta_i \leq c|T_i > t) \\
\end{align*}$$

from which one can defined an incident/dynamic receiver operator characteristic (ROC) curve (p denotes a dynamic  value of FP):

$$\begin{align*}
    \text{ROC}_t^{\mathbb{I}/\mathbb{D}}(p) =  \text{TP}_t^{\mathbb{I}}\{[\text{FP}_t^{\mathbb{D}}]^{-1}(p)\}
\end{align*}$$

Consequently I/D AUC:

$$\begin{align*}
    \text{AUC}^{\mathbb{I}/\mathbb{D}}(t) &= \int_0^1 \text{ROC}_t^{\mathbb{I}/\mathbb{D}}(p)dp
\end{align*}$$

### Hagerty & Zhang estimator (semi-parametric)

From the Heagerty & Zhang paper, sensitivity and specificity is estimated based on cox PH model:

$$\begin{align*}
    \log \lambda_i(t) &= \log \lambda_0(t) + \bf{x}_i \bf{\beta} \\
    &= \log \lambda_0(t) + \eta_i \\
\end{align*}$$

The sensitivity estimator is based on cox coefficients: 

$$\hat{\text{TP}_t}^{\mathbb{I}}(c)=\frac{\sum_{k}I(\eta_k>c)I(T_k=t)exp(\eta_t)}{\sum_{j}I(T_j=t)exp(\eta_j)}$$

But the 1-specificity is non-parametric:

$$\text{FP}_t^{\mathbb{D}}(c) = \frac{\sum_{k}I(\eta_k>c)I(T_k>t)}{\sum_{j}I(T_j>t)}$$

$ROC(t)$ and $AUC(t)$ estimated using formulas in section 2.1 by plugging in above estimators of TP and FP. $AUC(t)$ is only evaluated as unique event time. 

### Fully non-parametric

$$\hat{\text{TP}_t}^{\mathbb{I}}(c) = \frac{\sum_{k}I(\eta_k>c)I(T_k=t)}{\sum_{j}I(T_j=t)}$$
$$\hat{\text{FP}_t}^{\mathbb{D}}(c) = \frac{\sum_{k}I(\eta_k>c)I(T_k>t)}{\sum_{j}I(T_j>t)}$$

$ROC(t)$, $AUC(t)$ estimated using the same formula as previous sections

Since non-parametric $AUC(t)$ is highly unstable, we can also smoothing it using **regression splines**.

## Concordance

### Integrating AUC(t)

$$\begin{align*}
\text{C} &= \int_0^\tau\text{AUC}^{\mathbb{I}/\mathbb{D}}(t)w^{\tau(t)}dt
\end{align*}$$

Where $\tau$ is the end of follow-up period, and

$$w^{\tau}(t) = 2f(t)S(t)/W^{\tau}$$

$$W^{\tau} =\int_0^\tau2f(t)S(t)dt =1-S^2(\tau)$$
$S(t)$ can be estimated from Kaplan-Meier curve. $f(t)$ can be calculated using Trapezoidal rule over $S(t)$ or smoothed $S(t)$.

### Gonen & Heller

$$C = \frac{2}{n(n-1)}\sum_{i<j}{\frac{I(\eta_j-\eta_i<0)}{1+exp(\eta_j-\eta_i)}+\frac{I(\eta_i-\eta_j<0)}{1+exp(\eta_i-\eta_j)}}$$

### Harrel's C-index

$$C = \frac{\sum_{i<j}I(T_i<T_j)I(\eta_i>\eta_j)I(\delta_i=1)+I(T_i>T_j)I(\eta_i<\eta_j)I(\delta_i=1)}{\sum_{i<j}I(T_i<T_j)I(\delta_i=1)+I(T_i>T_j)I(\delta_i=1)}$$

# Results

## Simulation set up

- 1000 iterations, sample size = 500
- Signals $X = (X_1, X_2, X_3)$, $X_i \overset{i.i.d}{\sim} N(0, 1)$; true coefficients $\beta = (1, -1, 0.25)$; biomarker $\eta = \beta X$
- Event time generated from Weibull baseline hazard
- Censor time generated from exponential distribution, with maximum censor time $\tau = 1$

## Preliminary results

```{r}
load(here("outputData/true_values.RData"))
load(here("outputData/estimated_values.RData"))
load(here("outputData/weighted_gam_by_iter.RData"))
```

```{r}
auc_df <- auc_df %>% left_join(wt_gam_df, by = "time")
```


```{r}
# use interpolation to estimate true_auc
interpolated_auc<-approx(x = true_auc_sort$time_bin, y = true_auc_sort$auc, xout = auc_df$time)$y
# plot(auc_df$time, interpolated_auc)
auc_df$true <- interpolated_auc
```

```{r eval=FALSE}
auc_df %>% 
  pivot_longer(2:6, names_to = "estimator", values_to = "auc") %>%
  ggplot(aes(x = time, y = auc, col = estimator))+
  geom_line(alpha = 0.5)+
  labs(title = "True time-varying AUC")
```

```{r}
colnames(auc_df) <- c("time", "Heagerty-Zhang", "Non-parametric", "Smoothed non-parametric",
                      "Weighted smoothed non-parametric", "True")
```

```{r eval=FALSE}
auc_df %>% 
  pivot_longer(2:6, names_to = "estimator", values_to = "auc") %>%
  ggplot(aes(x = time, y = auc, group = estimator, col = estimator))+
  geom_point(na.rm = T, size = 0.5, alpha = 0.5)+
  labs(title = "Time-varying AUC")
```

```{r, fig.height=5, fig.width=10}
auc_df %>% 
  pivot_longer(2:6, names_to = "estimator", values_to = "auc") %>%
  ggplot(aes(x = time, y = auc, group = estimator, col = estimator))+
  geom_smooth(se = F, formula = y~s(x, bs = "cs"), na.rm = T, method = "gam", size = 0.7)+
  labs(title = "Smoothed time-varying AUC")
```

```{r, fig.height=5, fig.width=10}
brk <- seq(0, 1, 0.01)
auc_df %>%
  mutate(time_bin = cut(auc_df$time, breaks = brk, include.lowest = T,
                       seq(0.005, 0.995, 0.01))) %>%
  dplyr::select(-True) %>%
  pivot_longer(2:5, names_to = "estimator", values_to = "auc") %>%
  ggplot(aes(x = factor(time_bin), y = auc))+
  geom_boxplot(outlier.size = 0.5)+
  facet_wrap(~estimator, nrow = 4, ncol = 1)+
  labs(x = "", title = "Distribution of estimated AUC")+
  scale_x_discrete(breaks = c("0.005", "0.495", "0.995"))
```


```{r}
c_df$estimator <- factor(c_df$estimator, levels = levels(c_df$estimator),
                         labels = c("Harrel's C", "Gonen-Heller", "HZ_S",
                                    "HZ_SmS",
                                    "NP_S",
                                    "NP_SmS",
                                    "SNP_S",
                                    "SNP_SmS"))
c_df %>%  ggplot(aes(x = estimator, y = concordance))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 60, vjust = 0.5))+
  geom_hline(yintercept = true_c, col = "red")+
  labs(title = "Concordance")
```

Note: 

- HZ_S: Heagerty-Zhang estimator of $AUC(t)$ integrated using weights from survival function

- HZ_SmS: Heagerty-Zhang estimator of $AUC(t)$ integrated using weights from smoothed survival function

- NP_S: Non-parametric estimator of $AUC(t)$ integrated using weights from survival function


- NP_SmS: Non-parametric estimator of $AUC(t)$ integrated using weights from smoothed survival function

- SNP_S: Smoothed non-parametric estimator of $AUC(t)$ integrated using weights from survival function

- SNP_SmS: Smoothed non-parametric estimator of $AUC(t)$ integrated using weights from smoothed survival function



